name: Validate configuration

on:
  pull_request:
    branches:
      - master

jobs:
  helm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Lint Helm chart
        run: helm lint helm/nde-app

      - name: Validate HelmReleases
        run: |
          for hr in k8s/*/helmrelease.yaml; do
            echo "=== Validating $hr ==="
            name=$(yq '.metadata.name' "$hr")
            yq '.spec.values' "$hr" | helm template "$name" helm/nde-app -f - | kubeconform -strict -summary
          done

  k8s-do:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Store DigitalOcean credentials
        run: doctl kubernetes cluster kubeconfig save nde

      - name: Dry run apply to validate manifests
        run: |
          kubectl apply -R -f $GITHUB_WORKSPACE/k8s-do --dry-run=server

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: matomo
  namespace: nde
spec:
  serviceAccountName: nde
  interval: 30m
  chart:
    spec:
      chart: helm/nde-app
      reconcileStrategy: Revision
      sourceRef:
        kind: GitRepository
        name: nde
  values:
    workload:
      type: statefulset
    containers:
      - name: nginx
        image:
          repository: nginx
          tag: "1.29.4-alpine" # {"$imagepolicy": "nde:matomo-nginx:tag"}
        port: 80
        flux:
          policy:
            type: semver
            pattern: '^(?P<version>\d+\.\d+\.\d+)-alpine$'
            extract: '$version'
            range: "~1"
        volumeMounts:
          - name: data
            mountPath: /var/www/html
            readOnly: true
          - name: nginx-config
            mountPath: /etc/nginx/conf.d
      - name: php-fpm
        image:
          repository: matomo
          tag: "5.6.2-fpm-alpine" # {"$imagepolicy": "nde:matomo-php-fpm:tag"}
        port: 9000
        flux:
          policy:
            type: semver
            pattern: '^(?P<version>\d+\.\d+\.\d+)-fpm-alpine$'
            extract: '$version'
            range: "~5"
        env:
          - name: MATOMO_DATABASE_HOST
            value: matomo-mariadb
          - name: MATOMO_DATABASE_USERNAME
            valueFrom:
              secretKeyRef:
                name: matomo-mariadb
                key: mariadb-user
          - name: MATOMO_DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: matomo-mariadb
                key: mariadb-password
          - name: MATOMO_DATABASE_DBNAME
            value: matomo
        volumeMounts:
          - name: data
            mountPath: /var/www/html
    securityContext:
      fsGroup: 82
    persistentVolumes:
      - name: data
        size: 10Gi
    volumes:
      - name: nginx-config
        configMap:
          name: matomo-nginx
    configMaps:
      - name: nginx
        data:
          default.conf: |
            server {
                listen 80;
                server_name _;
                root /var/www/html;
                index index.php;

                client_max_body_size 50m;

                add_header Referrer-Policy origin always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;

                # Static assets with caching (must come before deny blocks)
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|json)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }

                # Deny access to sensitive directories
                location ~ ^/(config|tmp|core|lang) {
                    deny all;
                    return 404;
                }

                location ~ ^/(libs|vendor|plugins|misc|node_modules) {
                    deny all;
                    return 404;
                }

                location ~ /\.ht {
                    deny all;
                    return 404;
                }

                location / {
                    try_files $uri $uri/ =404;
                }

                # Only allow specific PHP files to execute
                location ~ ^/(index|matomo|piwik|js/index|plugins/HeatmapSessionRecording/configs)\.php$ {
                    fastcgi_pass 127.0.0.1:9000;
                    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                    include fastcgi_params;
                }

                # Deny all other PHP files
                location ~* ^.+\.php$ {
                    deny all;
                    return 404;
                }
            }
    ingresses:
      - hosts:
          - matomo.netwerkdigitaalerfgoed.nl
        annotations:
          nginx.ingress.kubernetes.io/proxy-body-size: "50m"

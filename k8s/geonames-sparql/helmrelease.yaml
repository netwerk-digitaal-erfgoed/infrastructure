apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: geonames-sparql
  namespace: nde
spec:
  serviceAccountName: nde
  interval: 30m
  chart:
    spec:
      chart: helm/nde-app
      reconcileStrategy: Revision
      sourceRef:
        kind: GitRepository
        name: nde
  values:
    workload:
      type: statefulset

    containers:
      - name: app
        image:
          repository: stain/jena-fuseki
          tag: "5.1.0" # {"$imagepolicy": "nde:geonames-sparql-fuseki:tag"}
        flux:
          policy:
            type: semver
            range: ">=5.1.0"
        port: 3030
        resources:
          requests:
            memory: 8Gi
        env:
          - name: JVM_ARGS
            value: "-Xmx8g -Xlog:gc*:stdout:time,level,tags"
        volumeMounts:
          - name: fuseki
            mountPath: /fuseki
          - name: config
            mountPath: /fuseki/config.ttl
            subPath: config.ttl
          - name: data
            mountPath: /data
            subPath: production
        livenessProbe:
          httpGet:
            path: /$/ping
        readinessProbe:
          httpGet:
            path: /$/ping

    securityContext:
      fsGroup: 100

    volumes:
      - name: config
        configMap:
          name: geonames-sparql-fuseki-config

    persistentVolumes:
      - name: data
        size: 50Gi
      - name: fuseki
        size: 10Gi

    service:
      port: 80
      targetPort: 3030

    ingresses:
      - hosts:
          - geonames.netwerkdigitaalerfgoed.nl
        paths:
          - path: /
            pathType: Prefix

    configMaps:
      - name: fuseki-config
        data:
          config.ttl: |
            @prefix :       <#> .
            @prefix fuseki: <http://jena.apache.org/fuseki#> .
            @prefix gn:     <https://www.geonames.org/ontology#> .
            @prefix tdb2:   <http://jena.apache.org/2016/tdb#> .
            @prefix text:   <http://jena.apache.org/text#> .

            [] a fuseki:Server ;
               fuseki:services (:geonames) .

            :geonames a fuseki:Service ;
                      fuseki:name "" ;
                      fuseki:label "GeoNames" ;
                      fuseki:serviceQuery "sparql" ;
                      fuseki:serviceReadGraphStore "get" ;
                      fuseki:dataset :textDataset ;
            .

            :textDataset a text:TextDataset ;
              text:dataset :dataset ;
              text:index :index ;
            .

            :dataset a tdb2:DatasetTDB2 ;
              tdb2:location "/data/tdb" ;
            .

            :index a text:TextIndexLucene ;
              text:directory <file:/data/index> ;
              text:entityMap :entityMap ;
            
              # The default analyzer skips tokens < 3 chars, such as country codes ('NL', 'BE').
              # Matching such short tokens is very slow, returning many irrelevant results.
              # Country code matching is handled in the SPARQL query instead.
              text:defineAnalyzers (
                [ text:defineFilter :lengthFilter ;
                  text:filter [
                    a text:GenericFilter ;
                    text:class "org.apache.lucene.analysis.miscellaneous.LengthFilter" ;
                    text:params (
                      [ text:paramName "min" ; text:paramValue 3 ]
                      [ text:paramName "max" ; text:paramValue 2147483647 ]
                    ) ] ]
              ) ;
              text:analyzer [
                a text:ConfigurableAnalyzer ;
                text:tokenizer text:StandardTokenizer ;
                text:filters ( text:ASCIIFoldingFilter text:LowerCaseFilter :lengthFilter ) ;
              ] ;
            .

            :entityMap a text:EntityMap ;
              text:defaultField "name" ;
              text:entityField "uri" ;
              text:map (
                [
                  text:field "name" ;
                  text:predicate gn:name ;
                  # text:boost is silently ignored (never implemented in Jena, removed from Lucene in 7.0).
                  # Boosting is done at query time using Lucene's ^N syntax in the SPARQL query instead.
                ]
                [
                  text:field "alternateName" ;
                  text:predicate gn:alternateName ;
                ]
                # countryCode is no longer in the text index;
                # country code matching is handled in the SPARQL query instead.
              ) ;
            .
